# Key_seg проект (DLC 2022 cv final)

Сегментация ключей на фотографиях для последующего определения типа ключа и декодирования кода ключа. Финальный проект курса DLC 2022, весенний поток.

# Описание

* Отобрали около 500 случайных фотографий ключей
* Разметили прямоугольниками для обучения детектора, делалось в [CVAT](http://cvat.org) (детектор нужен, потому что изначально фотографии очень большие и там много лишнего)
* В качестве детектора используем обученный ssd_coco из mmdetection, дообучаем его еще 5 эпох (делалось все в google_colab)
```
key_detection_training.ipynb
```
* Используя детектор готовим датасет для разметки под сегментацию
```
prep_datast_for_seg.ipynb
```
* Разметили области ключей на фотография* (главное - удаление теней и боковой стороны ключа), делалось на [supervisely](http://supervise.ly) с помощью Smart tool
    * размечено около 300 случайных фотографий
    * плохие изображения в ходе разметки помечались тэгами bad_image / mid_quality_image (например, изображения без ключа или очень темные)

### пример разметки    
![разметка](https://i.gyazo.com/789b6ea13e3e039076f5a79cd45036f3.png)

* Тренируем UNet для сегментации (делалось на kaggle)
```
key_segmentation_training.ipynb
```
* Пробуем с помощью Gradio сделать приложение для сегментации произвольных фотографий ключей
```
последняя часть в dlc_final_project.ipynb
```
### gradio app
![gradio](https://i.gyazo.com/b67744af0dafdf517e33cbe4a2acf73e.png)


# Особенности сегментации
* Аугментация
    * Случайный небольшой поворот
    * Случайный кроп (большого размера, так что выглядит просто как небольшие смещения ключа)
* Дополнение черными полосами до квадратного изображения
* Изменения размера до 512*512
* Разметка - 1 канальное изображение, входное - 3 канальное
* В качестве loss хорошо показал себя dice_loss
* Так как для нас очень важна граница, то дополнительно к dice_loss взяли boundary_loss (итоговый loss = dice + boundary)

### Пример сегментации
![пример сегментации](https://i.gyazo.com/c98a96734319b42c582f40e52811f657.png)

## Запуск

* Весь pipeline с готовыми моделями, без тренировки
```
dlc_final_project.ipynb
```

* В ноутбуках есть ссылки на часть данных
* Для тренировки и работы с детектором используется mmdetection (необходима установка - в ноутбуке все есть)

### Дальнейшие планы
* реализация ICNet 
Hengshuang Zhao, Xiaojuan Qi, Xiaoyong Shen, Jianping Shi, Jiaya Jia
ICNet for Real-Time Semantic Segmentation on High-Resolution Images
https://arxiv.org/abs/1704.08545
* реализация FPN 
Rory Smith, Tilo Burghardt
DeepKey: Towards End-to-End Physical Key Replication From a Single Photograph
https://arxiv.org/abs/1811.01405

## Использование данных и моделей

Запрещается любое использование данных, ссылки на которые есть в этом проекте и моделей, которые обучены в этом проекте. Данные принадлежат коммерческой компании.
